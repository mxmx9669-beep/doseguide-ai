<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DoseGuide AI</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --pri:#2563eb; --line:#e2e8f0; --ok:#16a34a; --bad:#dc2626;
      --shadow:0 18px 45px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:22px}
    .title{display:flex;align-items:center;gap:10px;font-size:28px;font-weight:800;margin:0 0 16px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    select,textarea{
      width:100%;border:1px solid var(--line);border-radius:12px;
      padding:12px;background:#fff;font-size:14px;outline:none
    }
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{
      border:0;border-radius:12px;padding:12px 14px;
      background:var(--pri);color:#fff;font-weight:700;cursor:pointer;min-width:180px
    }
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line)}
    .modes{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .mode{
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:10px 14px;cursor:pointer;font-weight:700;color:var(--muted)
    }
    .mode.active{border-color:var(--pri);color:var(--pri);box-shadow:0 10px 25px rgba(37,99,235,.12)}
    .out{margin-top:16px;border-top:1px solid var(--line);padding-top:16px}
    .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    pre{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;padding:14px;border-radius:14px;overflow:auto}
    .small{font-size:12px;color:var(--muted)}
    .cite{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;margin-top:10px}
    .cite b{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">ðŸ’Š DoseGuide AI <span class="pill" id="healthPill">Worker: checkingâ€¦</span></h1>

      <div class="grid">
        <div>
          <label>Drug/Topic (auto from your files)</label>
          <select id="drug">
            <option value="">(Optional) None</option>
          </select>
          <div class="small" id="catalogHint" style="margin-top:6px;"></div>
        </div>

        <div>
          <label>Language</label>
          <select id="lang">
            <option value="English">English</option>
            <option value="Arabic">Arabic</option>
          </select>
        </div>

        <div>
          <label>Answer Style</label>
          <select id="style">
            <option value="Recommended">Recommended</option>
            <option value="Bullet">Bullet</option>
            <option value="Detailed">Detailed</option>
          </select>
        </div>
      </div>

      <div style="margin-top:14px">
        <label>Output Mode</label>
        <div class="modes">
          <button class="mode active" data-mode="Hybrid">Hybrid</button>
          <button class="mode" data-mode="Short">Short</button>
          <button class="mode" data-mode="Verbatim">Verbatim</button>
          <button class="mode" data-mode="Source">Source</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <label>Your Question</label>
        <textarea id="q" placeholder="Ask based on your uploaded PDFs..."></textarea>
      </div>

      <div class="row">
        <button class="btn" id="askBtn">Ask DoseGuide</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
      </div>

      <div class="out" id="out" style="display:none">
        <div class="status">
          <span class="dot" id="dot"></span>
          <b id="verdict">Verdict</b>
          <span class="small" id="endpoint"></span>
        </div>

        <div id="answerBox"></div>
        <div id="citationsBox"></div>

        <div style="margin-top:12px">
          <div class="small">Raw JSON</div>
          <pre id="raw"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
  // âœ… Ø­Ø· Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Worker (ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·)
  const WORKER_BASE = "https://lingering-mode-e7c2.mxmxx9669.workers.dev";

  const elDrug = document.getElementById("drug");
  const elLang = document.getElementById("lang");
  const elStyle = document.getElementById("style");
  const elQ = document.getElementById("q");
  const elOut = document.getElementById("out");
  const elVerdict = document.getElementById("verdict");
  const elDot = document.getElementById("dot");
  const elEndpoint = document.getElementById("endpoint");
  const elRaw = document.getElementById("raw");
  const elAnswerBox = document.getElementById("answerBox");
  const elCitationsBox = document.getElementById("citationsBox");
  const elHealthPill = document.getElementById("healthPill");
  const elCatalogHint = document.getElementById("catalogHint");

  let outputMode = "Hybrid";

  document.querySelectorAll(".mode").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".mode").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      outputMode = btn.dataset.mode;
    });
  });

  document.getElementById("clearBtn").addEventListener("click", ()=>{
    elQ.value = "";
    elOut.style.display = "none";
  });

  async function healthCheck(){
    try{
      const r = await fetch(WORKER_BASE + "/health");
      await r.text();
      elHealthPill.textContent = r.ok ? "Worker: OK" : "Worker: ERROR";
      elHealthPill.style.color = r.ok ? "#16a34a" : "#dc2626";
    }catch(e){
      elHealthPill.textContent = "Worker: not reachable";
      elHealthPill.style.color = "#dc2626";
    }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadCatalog(){
    try{
      const r = await fetch(WORKER_BASE + "/catalog");
      const data = await r.json();
      if(!data?.ok) throw new Error("catalog failed");

      const files = Array.isArray(data.files) ? data.files : [];
      elCatalogHint.textContent = files.length ? `Loaded ${files.length} files from Vector Store.` : "No files found.";

      // reset options (keep first)
      elDrug.innerHTML = `<option value="">(Optional) None</option>`;
      files.forEach(f=>{
        const name = f.filename || f.file_id || "unknown";
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        elDrug.appendChild(opt);
      });
    }catch(e){
      elCatalogHint.textContent = "Could not load catalog (check Worker /catalog).";
    }
  }

  function renderResult(data){
    elOut.style.display = "block";
    elEndpoint.textContent = "Endpoint: " + WORKER_BASE + "/ask";

    const verdict = data?.verdict || (data?.ok === false ? "ERROR" : "UNKNOWN");
    elVerdict.textContent = "Verdict: " + verdict;
    elDot.className = "dot " + ((verdict === "OK") ? "ok" : "bad");

    elAnswerBox.innerHTML = "";
    elCitationsBox.innerHTML = "";

    const ans = (data?.answer || "").trim();
    if(ans){
      const pre = document.createElement("pre");
      pre.textContent = ans;
      elAnswerBox.appendChild(pre);
    }

    const cits = Array.isArray(data?.citations) ? data.citations : [];
    if(cits.length){
      const h = document.createElement("div");
      h.className = "small";
      h.textContent = "Citations";
      elCitationsBox.appendChild(h);

      cits.forEach(c=>{
        const div = document.createElement("div");
        div.className = "cite";
        const page = (c.page === null || c.page === undefined) ? "" : (" | page: " + c.page);
        div.innerHTML = `
          <b>${escapeHtml(c.filename || "unknown")}${escapeHtml(page)}</b>
          <div class="small">Evidence: ${(c.evidence_ids || []).join(", ")}</div>
          <div style="margin-top:8px; white-space:pre-wrap">${escapeHtml(c.excerpt || "")}</div>
        `;
        elCitationsBox.appendChild(div);
      });
    }

    elRaw.textContent = JSON.stringify(data, null, 2);
  }

  document.getElementById("askBtn").addEventListener("click", async ()=>{
    const question = elQ.value.trim();
    if(question.length < 2){ alert("Write a question first."); return; }

    const payload = {
      question,
      drug: elDrug.value.trim(),      // now filled from catalog filenames/topics
      language: elLang.value,
      answer_style: elStyle.value,
      output_mode: outputMode
    };

    elOut.style.display = "block";
    elVerdict.textContent = "Verdict: ...";
    elDot.className = "dot";
    elEndpoint.textContent = "Endpoint: " + WORKER_BASE + "/ask";
    elAnswerBox.innerHTML = "<div class='small'>Loadingâ€¦</div>";
    elCitationsBox.innerHTML = "";
    elRaw.textContent = "";

    try{
      const r = await fetch(WORKER_BASE + "/ask", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=>({ ok:false, error:"BAD_JSON" }));
      renderResult(data);
    }catch(e){
      renderResult({ ok:false, verdict:"ERROR", answer:"Request failed.", citations:[], details:String(e) });
    }
  });

  healthCheck();
  loadCatalog();
</script>
</body>
</html>
