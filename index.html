<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DoseGuide AI</title>

<style>
  :root{
    --pri:#2563eb;
    --bg:#f6f8fc;
    --card:#ffffff;
    --border:#e5eaf3;
    --text:#0f172a;
    --muted:#64748b;
    --radius:18px;
    --shadow:0 12px 28px rgba(15, 23, 42, .08);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{margin:0;background:var(--bg);color:var(--text);}
  .wrap{max-width:1120px;margin:0 auto;padding:34px 18px 60px;}
  .top{
    display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:22px;
  }
  .brand{display:flex;align-items:center;gap:12px;}
  .mark{
    width:42px;height:42px;border-radius:14px;
    background:linear-gradient(135deg, #60a5fa, #2563eb);
    box-shadow:var(--shadow);
  }
  .title{font-size:28px;font-weight:800;letter-spacing:.2px;color:#1d4ed8;}
  .pill{
    font-size:13px;color:#1d4ed8;background:#eaf2ff;border:1px solid #d7e6ff;
    padding:8px 12px;border-radius:999px;font-weight:700;
  }
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:18px;}
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:18px;
  }
  .card h3{margin:0 0 12px;font-size:18px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;}
  select, textarea, input{
    width:100%;border:1px solid var(--border);border-radius:14px;
    padding:14px 14px;font-size:14px;outline:none;background:#fff;
    transition:border .15s, box-shadow .15s;
  }
  select:focus, textarea:focus, input:focus{
    border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.14);
  }
  textarea{min-height:180px;resize:vertical;line-height:1.35;}
  .actions{display:flex;gap:10px;align-items:center;margin-top:12px;}
  button{
    border:0;border-radius:14px;padding:12px 16px;font-weight:800;
    cursor:pointer;font-size:14px;
  }
  .btn-primary{background:var(--pri);color:#fff;}
  .btn-primary:hover{filter:brightness(.98);}
  .btn-ghost{background:#eef2ff;color:#1e3a8a;}
  .btn-ghost:hover{filter:brightness(.98);}
  .hint{margin-top:10px;color:var(--muted);font-size:12.5px;}
  .result{
    border:1px solid var(--border);border-radius:14px;padding:14px;background:#fbfcff;
    white-space:pre-wrap;min-height:260px;overflow:auto;font-size:14px;line-height:1.4;
  }
  .status{margin-top:10px;font-size:12.5px;color:var(--muted);}
  .ok{color:#16a34a;font-weight:700;}
  .bad{color:#dc2626;font-weight:700;}
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="mark"></div>
        <div class="title">DoseGuide AI</div>
      </div>
      <div class="pill">Protocol Locked</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Ask a Clinical Question</h3>

        <select id="drugSelect" aria-label="Drug">
          <option value="">Select drug</option>
        </select>

        <textarea
          id="question"
          placeholder="Type your clinical question..."
          spellcheck="true"
          autocomplete="on"
        ></textarea>

        <div class="actions">
          <button class="btn-primary" id="askBtn">Ask</button>
          <button class="btn-ghost" id="clearBtn" type="button">Clear</button>
        </div>

        <div class="hint">
          Answers are restricted to the selected drug PDF protocol only.
        </div>
      </div>

      <div class="card">
        <h3>Result</h3>
        <div id="result" class="result">Ready.</div>
        <div id="status" class="status">Status: <span class="ok">Idle</span></div>
      </div>
    </div>
  </div>

<script>
  // ✅ Put your REAL worker URL here (note: mxmx9669)
  const API_ENDPOINT = "https://steep-frost-149fdoseguide-api.mxmx9669.workers.dev";

  // ✅ Load list from local repo file (must exist in Pages root)
  async function loadDrugs(){
    try{
      const res = await fetch("./vectorstores.json", { cache: "no-store" });
      if(!res.ok) throw new Error("vectorstores.json not reachable");
      const data = await res.json();

      const select = document.getElementById("drugSelect");
      const keys = Object.keys(data).sort((a,b)=>a.localeCompare(b));
      for(const k of keys){
        const o = document.createElement("option");
        o.value = k;
        o.textContent = k;
        select.appendChild(o);
      }
    }catch(e){
      console.warn("Drug list not loaded:", e);
      // fallback minimal options if file missing
      const select = document.getElementById("drugSelect");
      ["Ciprofloxacin","Levofloxacin","Meropenem","Vancomycin"].forEach(k=>{
        const o=document.createElement("option");
        o.value=k; o.textContent=k;
        select.appendChild(o);
      });
    }
  }

  function setStatus(text, ok=true){
    const el = document.getElementById("status");
    el.innerHTML = `Status: <span class="${ok ? "ok":"bad"}">${text}</span>`;
  }

  async function ask(){
    const drug = document.getElementById("drugSelect").value;
    const question = document.getElementById("question").value.trim();
    const resultBox = document.getElementById("result");

    if(!drug || !question){
      resultBox.textContent = "Please select a drug and enter a question.";
      setStatus("Missing input", false);
      return;
    }

    resultBox.textContent = "Processing...";
    setStatus("Connecting...", true);

    try{
      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ drug, question })
      });

      const data = await res.json().catch(()=> ({}));
      const ans = (data && data.answer) ? String(data.answer) : "No response returned.";

      resultBox.textContent = ans;
      setStatus(res.ok ? "OK" : "Error", res.ok);

    }catch(err){
      console.error(err);
      resultBox.textContent = "Error connecting to server.";
      setStatus("Network error", false);
    }
  }

  function clearAll(){
    document.getElementById("question").value = "";
    document.getElementById("result").textContent = "Ready.";
    setStatus("Idle", true);
  }

  document.getElementById("askBtn").addEventListener("click", ask);
  document.getElementById("clearBtn").addEventListener("click", clearAll);

  // Submit on Ctrl+Enter
  document.getElementById("question").addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === "Enter") ask();
  });

  loadDrugs();
</script>
</body>
</html>
