<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DoseGuide AI ‚Äì Adult Antimicrobial Guidelines</title>
  <style>
    :root{
      --bg:#0B1220; --card:#0F1A2E; --card2:#0D172A;
      --line:#20304B; --text:#E6EEF9; --muted:#9FB0C6;
      --pri:#4DA3FF; --pri2:#7CC7FF; --ok:#2DD4BF; --bad:#FB7185; --warn:#FBBF24;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1100px 700px at 20% 0%, rgba(77,163,255,.22), transparent 60%),
                         radial-gradient(900px 600px at 90% 20%, rgba(45,212,191,.14), transparent 55%),
                         var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    .wrap{max-width:1100px; margin:28px auto; padding:0 18px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(77,163,255,1), rgba(124,199,255,1));
      box-shadow: 0 12px 30px rgba(77,163,255,.22);
    }
    .title h1{margin:0; font-size:22px; letter-spacing:.2px}
    .title p{margin:3px 0 0; color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(124,199,255,.35);
      background: rgba(15,26,46,.75);
      color:var(--pri2); font-size:12px;
    }
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: rgba(15,26,46,.72);
      border:1px solid rgba(32,48,75,.85);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid rgba(32,48,75,.85);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd b{font-size:14px}
    .card .bd{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    textarea{
      width:100%; min-height:140px; resize:vertical;
      background: rgba(13,23,42,.9);
      border:1px solid rgba(32,48,75,.9);
      border-radius: 14px;
      color: var(--text);
      padding:12px 12px;
      font-size:14px; line-height:1.55;
      outline:none;
    }
    textarea:focus{border-color: rgba(124,199,255,.55); box-shadow: 0 0 0 4px rgba(77,163,255,.12);}
    .btn{
      border:1px solid rgba(77,163,255,.45);
      background: linear-gradient(180deg, rgba(77,163,255,.25), rgba(77,163,255,.12));
      color: var(--text);
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      transition:.15s transform, .15s opacity;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn.secondary{
      border:1px solid rgba(32,48,75,.85);
      background: rgba(13,23,42,.85);
      color: var(--muted);
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid rgba(32,48,75,.85);
      background: rgba(13,23,42,.85);
      color: var(--muted);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size:12px;
    }
    .seg button.active{
      border-color: rgba(124,199,255,.55);
      color: var(--pri2);
      background: rgba(77,163,255,.12);
    }
    .meta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .badge{
      font-family:var(--mono);
      border:1px solid rgba(32,48,75,.85);
      background: rgba(13,23,42,.7);
      padding:6px 10px; border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--warn);}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .out{
      background: rgba(13,23,42,.9);
      border:1px solid rgba(32,48,75,.9);
      border-radius: 14px;
      padding:12px 12px;
      min-height: 220px;
      white-space: pre-wrap;
      line-height:1.6;
      font-size:14px;
    }
    .small{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .foot{
      margin-top:14px;
      color: rgba(159,176,198,.9);
      font-size:12px;
    }
    a{color: var(--pri2); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>DoseGuide AI</h1>
          <p>Adult Antimicrobial Guidelines ‚Äî Protocol-Locked Q&amp;A</p>
        </div>
      </div>
      <div class="pill">üîí Locked to: Antimicrobial PDF</div>
    </div>

    <div class="grid">
      <!-- Left: Ask -->
      <div class="card">
        <div class="hd">
          <b>Ask a clinical question</b>
          <div class="seg" id="modeSeg">
            <button data-mode="hybrid" class="active" title="Best balance">Hybrid</button>
            <button data-mode="short" title="Just the answer">Short</button>
            <button data-mode="source" title="Only evidence">Source</button>
          </div>
        </div>
        <div class="bd">
          <textarea id="q" placeholder="Example:
‚Ä¢ Empiric therapy for community-acquired pneumonia?
‚Ä¢ Dose adjustment in renal impairment for ...?
‚Ä¢ Duration of therapy for ...?"></textarea>

          <div class="row" style="margin-top:12px; align-items:center; justify-content:space-between;">
            <div class="row" style="gap:8px;">
              <button class="btn" id="askBtn">Ask</button>
              <button class="btn secondary" id="clearBtn">Clear</button>
            </div>
            <div class="meta">
              <span class="badge"><span class="dot" id="statusDot"></span><span id="statusTxt">Idle</span></span>
              <span class="badge">Locked: <b style="color:var(--pri2)">YES</b></span>
            </div>
          </div>

          <div class="foot">
            This tool answers only from the uploaded guideline (vector store). If not found, it returns <span style="font-family:var(--mono)">Not found in protocol</span>.
          </div>
        </div>
      </div>

      <!-- Right: Result -->
      <div class="card">
        <div class="hd">
          <b>Result</b>
          <div class="meta">
            <span class="badge">Verdict: <b id="verdict" style="color:var(--warn)">‚Äî</b></span>
          </div>
        </div>
        <div class="bd">
          <div class="out" id="answer">‚Äî</div>
          <div class="small" style="margin-top:10px;">
            Tip: ask specific (indication + patient factors). Example: ‚ÄúAdult, CrCl 25 mL/min, suspected pyelonephritis ‚Äî recommended empiric antibiotics?‚Äù
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const q = document.getElementById("q");
    const askBtn = document.getElementById("askBtn");
    const clearBtn = document.getElementById("clearBtn");
    const answerEl = document.getElementById("answer");
    const verdictEl = document.getElementById("verdict");
    const statusDot = document.getElementById("statusDot");
    const statusTxt = document.getElementById("statusTxt");
    const modeSeg = document.getElementById("modeSeg");

    let mode = "hybrid";

    function setStatus(state, text) {
      statusTxt.textContent = text || state;
      statusDot.classList.remove("ok", "bad");
      if (state === "ok") statusDot.classList.add("ok");
      else if (state === "bad") statusDot.classList.add("bad");
    }

    function setMode(m){
      mode = m;
      [...modeSeg.querySelectorAll("button")].forEach(b=>{
        b.classList.toggle("active", b.dataset.mode === m);
      });
    }

    modeSeg.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-mode]");
      if (!btn) return;
      setMode(btn.dataset.mode);
    });

    clearBtn.addEventListener("click", () => {
      q.value = "";
      answerEl.textContent = "‚Äî";
      verdictEl.textContent = "‚Äî";
      verdictEl.style.color = "var(--warn)";
      setStatus("idle", "Idle");
      q.focus();
    });

    async function ask() {
      const question = q.value.trim();
      if (!question) return;

      askBtn.disabled = true;
      setStatus("idle", "Working‚Ä¶");
      answerEl.textContent = "Thinking‚Ä¶";
      verdictEl.textContent = "‚Äî";
      verdictEl.style.color = "var(--warn)";

      try {
        // We can influence style by prefixing the user question (server remains locked).
        let prompt = question;
        if (mode === "short") prompt = "Answer briefly.\n\n" + question;
        if (mode === "source") prompt = "Return only the Evidence quotes.\n\n" + question;

        const r = await fetch("/.netlify/functions/ask", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ question: prompt })
        });

        const data = await r.json();
        if (!r.ok || !data?.ok) throw new Error(data?.error || "Request failed");

        const ans = (data.answer || "").trim();
        answerEl.textContent = ans || "Not found in protocol";

        const verdict = data.verdict || (ans === "Not found in protocol" ? "NOT_FOUND" : "FOUND");
        verdictEl.textContent = verdict;

        if (verdict === "FOUND") {
          verdictEl.style.color = "var(--ok)";
          setStatus("ok", "OK");
        } else {
          verdictEl.style.color = "var(--bad)";
          setStatus("bad", "NOT FOUND");
        }
      } catch (e) {
        answerEl.textContent = "Error: " + (e?.message || e);
        verdictEl.textContent = "ERROR";
        verdictEl.style.color = "var(--bad)";
        setStatus("bad", "Error");
      } finally {
        askBtn.disabled = false;
      }
    }

    askBtn.addEventListener("click", ask);
    q.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") ask();
    });

    setStatus("idle", "Idle");
  </script>
</body>
</html>
