<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DoseGuide AI — Q&A</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#0c1527;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;
      --accent:#60a5fa;
      --radius:18px;
      --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(1000px 600px at 90% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:34px auto;padding:0 16px}
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow: var(--shadow);
      padding:22px 22px 18px;
    }
    .title{
      display:flex;align-items:center;gap:14px;
      margin:0 0 6px 0;
    }
    .logo{
      width:54px;height:54px;border-radius:16px;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(34,197,94,1));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    h1{font-size:28px;margin:0}
    .sub{color:var(--muted);margin:0 0 14px 0;line-height:1.45}
    .badges{display:flex;gap:10px;flex-wrap:wrap}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color: var(--muted);
      font-size:13px;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 12px 0;font-size:16px;color:#dbe7ff}
    label{display:block;color:var(--muted);font-size:13px;margin:10px 0 6px}
    input, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    textarea{min-height:160px;resize:vertical}
    input:focus, textarea:focus{border-color: rgba(96,165,250,.6); box-shadow: 0 0 0 3px rgba(96,165,250,.14)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{
      appearance:none;border:0;cursor:pointer;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(34,197,94,1));
      color:#06101f;font-weight:800;
      padding:12px 14px;border-radius:14px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .ghost{
      background: transparent;
      color: var(--muted);
      border:1px solid var(--line);
      padding:12px 14px;border-radius:14px;
      cursor:pointer;
    }

    .resultBox{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      min-height:220px;
      white-space:pre-wrap;
      line-height:1.55;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      color: var(--muted);font-size:13px;background: rgba(0,0,0,.12);
    }
    .footerTip{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.5}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="title">
        <div class="logo"></div>
        <div>
          <h1>DoseGuide AI</h1>
          <p class="sub">واجهة سؤال/جواب فقط — (Protocol-Locked) الهدف: الإجابة من البروتوكول المختار فقط.</p>
        </div>
      </div>
      <div class="badges">
        <span class="badge"><span class="dot ok"></span>Ready</span>
        <span class="badge"><span class="dot warn"></span>Clinical tool — verify with full guideline</span>
        <span class="badge"><span class="dot ok"></span>Uses Worker API</span>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Ask -->
      <div class="card">
        <h2>Ask from Protocol</h2>

        <label>Worker URL</label>
        <input id="workerUrl" placeholder="https://xxxx.workers.dev" />

        <label>Protocol ID (Vector Store ID)</label>
        <input id="protocolId" placeholder="مثال: vs_123..." />

        <label>Question</label>
        <textarea id="question" placeholder="اكتب سؤالك هنا..."></textarea>

        <div class="row">
          <button class="btn" id="askBtn">Ask</button>
          <button class="ghost" id="clearBtn">Clear</button>
        </div>

        <div class="footerTip">
          ملاحظة: إذا ظهر “Not found in protocol” فهذا غالبًا لأن الربط بالـ Vector Store داخل الـ Worker لم يُفعل بعد.
        </div>
      </div>

      <!-- Right: Result -->
      <div class="card">
        <div class="meta">
          <span class="pill"><span class="dot ok" id="statusDot"></span><span id="statusText">Idle</span></span>
          <span class="pill">Verdict: <b id="verdictText" style="color:#dbe7ff;margin-inline-start:6px;">—</b></span>
        </div>
        <div class="resultBox" id="resultBox">اكتب سؤال واضغط Ask…</div>
      </div>
    </div>
  </div>

  <script>
    // ✅ غيّر هذا لرابط الـ Worker عندك
    const DEFAULT_WORKER_URL = "https://shrill-paper-51ae.mxmxxxx.workers.dev";

    const el = (id) => document.getElementById(id);
    const workerUrl = el("workerUrl");
    const protocolId = el("protocolId");
    const question = el("question");
    const askBtn = el("askBtn");
    const clearBtn = el("clearBtn");
    const resultBox = el("resultBox");
    const statusText = el("statusText");
    const verdictText = el("verdictText");
    const statusDot = el("statusDot");

    // load saved
    workerUrl.value = localStorage.getItem("dg_worker_url") || DEFAULT_WORKER_URL;
    protocolId.value = localStorage.getItem("dg_protocol_id") || "";

    function setStatus(state, verdict, msg) {
      statusText.textContent = state;
      verdictText.textContent = verdict || "—";
      resultBox.textContent = msg ?? resultBox.textContent;

      statusDot.className = "dot " + (state === "Done" ? "ok" : state === "Error" ? "bad" : "warn");
    }

    clearBtn.addEventListener("click", () => {
      question.value = "";
      resultBox.textContent = "تم المسح. اكتب سؤال واضغط Ask…";
      setStatus("Idle", "—");
    });

    askBtn.addEventListener("click", async () => {
      const url = workerUrl.value.trim();
      const q = question.value.trim();
      const pid = protocolId.value.trim();

      localStorage.setItem("dg_worker_url", url);
      localStorage.setItem("dg_protocol_id", pid);

      if (!url) return setStatus("Error", "ERROR", "حط Worker URL أولاً.");
      if (!q) return setStatus("Error", "ERROR", "اكتب السؤال أولاً.");

      setStatus("Working", "…", "جارٍ الإرسال…");
      askBtn.disabled = true;

      try {
        const payload = {
          question: q,
          protocol_id: pid || null,   // نرسل البروتوكول ID (لاحقًا الـ Worker يستخدمه)
          // context: ""               // لاحقًا إذا احتجنا
        };

        const res = await fetch(url, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data) {
          setStatus("Error", "ERROR", `HTTP ${res.status}\n` + (data ? JSON.stringify(data, null, 2) : "No JSON response"));
        } else {
          // نتوقع من الـ Worker يرجع { ok:true, answer:"..." } أو { ok:false, ... }
          if (data.ok) {
            const ans = data.answer ?? data.output ?? data.text ?? JSON.stringify(data, null, 2);
            // لو عندك verdict يرجعها الـ worker نعرضها
            const v = data.verdict || "OK";
            setStatus("Done", v, ans);
          } else {
            setStatus("Error", data.verdict || "ERROR", data.error ? JSON.stringify(data, null, 2) : "Unknown error");
          }
        }
      } catch (e) {
        setStatus("Error", "ERROR", "Fetch failed:\n" + String(e));
      } finally {
        askBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
